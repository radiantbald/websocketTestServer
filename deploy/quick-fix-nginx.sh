#!/bin/bash

# Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
# Ð£Ð´Ð°Ð»ÑÐµÑ‚ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽÑ‰Ð¸ÐµÑÑ location Ð±Ð»Ð¾ÐºÐ¸

set -e

log() {
    echo -e "\033[0;32m[$(date +'%H:%M:%S')] $1\033[0m"
}

error() {
    echo -e "\033[0;31m[$(date +'%H:%M:%S')] ERROR: $1\033[0m"
}

NGINX_CONFIG="/etc/nginx/sites-available/qabase.ru"

log "ðŸ”§ Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ
sudo cp "$NGINX_CONFIG" "$NGINX_CONFIG.backup.$(date +%Y%m%d-%H%M%S)"

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽÑ‰Ð¸ÐµÑÑ location /websocket Ð±Ð»Ð¾ÐºÐ¸
log "ðŸ—‘ï¸  Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ñ…ÑÑ Ð±Ð»Ð¾ÐºÐ¾Ð²..."
sudo sed -i '/location \/websocket {/,/}/d' "$NGINX_CONFIG"

# ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¼ÐµÑÑ‚Ð¾ Ð´Ð»Ñ Ð²ÑÑ‚Ð°Ð²ÐºÐ¸ (Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÑŽÑ‰ÐµÐ¹ ÑÐºÐ¾Ð±ÐºÐ¾Ð¹ server Ð±Ð»Ð¾ÐºÐ°)
log "ðŸ“ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ WebSocket Ð±Ð»Ð¾ÐºÐ°..."
# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ñ‹Ð¼
TEMP_FILE=$(mktemp)

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð´Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÑŽÑ‰ÐµÐ¹ ÑÐºÐ¾Ð±ÐºÐ¸
sudo sed '$d' "$NGINX_CONFIG" > "$TEMP_FILE"

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ WebSocket Ð±Ð»Ð¾ÐºÐ¸
cat >> "$TEMP_FILE" << 'EOF'
    
    # WebSocket Ð¿Ñ€Ð¾ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
    location /websocket {
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ WebSocket Ð·Ð°Ð¿Ñ€Ð¾Ñ
        if ($http_upgrade != "websocket") {
            return 400;
        }
        
        proxy_pass http://127.0.0.1:9092;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_connect_timeout 60;
        
        # Ð‘ÑƒÑ„ÐµÑ€Ð¸Ð·Ð°Ñ†Ð¸Ñ
        proxy_buffering off;
        proxy_cache off;
    }
    
    # WebSocket Ñ‚ÐµÑÑ‚Ð¾Ð²Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°
    location /websocket-test {
        alias /var/www/qabase/client/test-client.html;
        try_files $uri =404;
    }
}
EOF

# Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
sudo cp "$TEMP_FILE" "$NGINX_CONFIG"
rm "$TEMP_FILE"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ
log "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ°..."
if sudo nginx -t; then
    log "âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½"
    sudo systemctl reload nginx
    log "âœ… Nginx Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
else
    error "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐµ!"
    exit 1
fi

log "ðŸŽ‰ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
