<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - Simple</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .connecting { background: #fff3cd; color: #856404; }
        
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        .sent { background: #d1ecf1; text-align: right; }
        .received { background: #d4edda; }
        .system { background: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå WebSocket Test (Simple)</h1>
        
        <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
        
        <div>
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" value="–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫">
            <button id="connectBtn" onclick="toggleConnection()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
        
        <div id="messageSection" style="display: none;">
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width: 70%;">
            <button id="sendBtn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            
            <div>
                <button onclick="sendPing()">Ping</button>
                <button onclick="sendEcho()">Echo</button>
                <button onclick="clearMessages()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
        
        <div class="messages" id="messages"></div>
    </div>

    <script>
        let ws = null;
        
        function updateStatus(status, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = status;
            statusEl.className = `status ${className}`;
            
            const messageSection = document.getElementById('messageSection');
            if (className === 'connected') {
                messageSection.style.display = 'block';
            } else {
                messageSection.style.display = 'none';
            }
        }
        
        function addMessage(type, content, className = '') {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${className}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageEl.innerHTML = `<strong>[${timestamp}]</strong> ${content}`;
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function toggleConnection() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                disconnect();
            } else {
                connect();
            }
        }
        
        function connect() {
            const username = document.getElementById('username').value || 'Anonymous';
            const wsUrl = `wss://qabase.ru/api/websocket?username=${encodeURIComponent(username)}`;
            
            console.log('üîå –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫:', wsUrl);
            updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'connecting');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                document.getElementById('connectBtn').textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è';
                addMessage('system', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É');
            };
            
            ws.onmessage = function(event) {
                console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', event.data);
                try {
                    const message = JSON.parse(event.data);
                    const currentUsername = document.getElementById('username').value || 'Anonymous';
                    const isOwnMessage = message.username === currentUsername;
                    
                    if (message.type === 'chat') {
                        const className = isOwnMessage ? 'sent' : 'received';
                        const prefix = isOwnMessage ? '–í—ã' : (message.username || 'Server');
                        addMessage('received', `${prefix}: ${message.content}`, className);
                    } else {
                        addMessage('received', `${message.username || 'Server'}: ${message.content || event.data}`, 'received');
                    }
                } catch (e) {
                    addMessage('received', `Raw: ${event.data}`, 'received');
                }
            };
            
            ws.onclose = function(event) {
                console.log('‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç:', event.code, event.reason);
                updateStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'disconnected');
                document.getElementById('connectBtn').textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
                addMessage('system', `‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ (–∫–æ–¥: ${event.code})`);
            };
            
            ws.onerror = function(error) {
                console.error('üí• WebSocket –æ—à–∏–±–∫–∞:', error);
                addMessage('system', 'üí• –û—à–∏–±–∫–∞ WebSocket', 'system');
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (content && ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'chat',
                    content: content
                };
                
                const messageStr = JSON.stringify(message);
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ:', messageStr);
                
                ws.send(messageStr);
                input.value = '';
            }
        }
        
        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = { type: 'ping' };
                const messageStr = JSON.stringify(message);
                console.log('üèì –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping:', messageStr);
                ws.send(messageStr);
                addMessage('system', 'üèì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω ping');
            }
        }
        
        function sendEcho() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = { type: 'echo', content: 'Test echo message' };
                const messageStr = JSON.stringify(message);
                console.log('üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º echo:', messageStr);
                ws.send(messageStr);
                addMessage('system', 'üîÑ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω echo');
            }
        }
        
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        console.log('üöÄ WebSocket Test –∑–∞–≥—Ä—É–∂–µ–Ω');
        addMessage('system', 'üöÄ WebSocket Test –∑–∞–≥—Ä—É–∂–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
    </script>
</body>
</html>
